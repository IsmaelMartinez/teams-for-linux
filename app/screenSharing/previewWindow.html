<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Teams for Linux - Screen Share Preview</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-sizing: border-box;
        }
        
        #screen-share-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background-color: #000;
        }

        .status-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            font-size: 12px;
            text-align: center;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div class="status-overlay">Screen Share Preview</div>
    <video id="screen-share-video" autoplay muted></video>

    <script>
        window.addEventListener('DOMContentLoaded', async () => {
            const videoElement = document.getElementById('screen-share-video');
            const statusOverlay = document.querySelector('.status-overlay');

            const updateStatusAndStream = async () => {
                try {
                    const isActive = await window.electronAPI.getScreenSharingStatus();
                    
                    if (isActive) {
                        statusOverlay.textContent = 'Screen Share Active';
                        document.title = 'Teams for Linux - Screen is being shared';

                        const sourceId = await window.electronAPI.getScreenShareStream();
                        const screenSize = await window.electronAPI.getScreenShareScreen();
                        
                        console.debug('Screen sharing status:', isActive, 'Source ID:', sourceId, 'Screen size:', screenSize);
                        
                        if (sourceId) {
                            const stream = await navigator.mediaDevices.getUserMedia({
                                audio: false,
                                video: {
                                    mandatory: {
                                        chromeMediaSource: 'desktop',
                                        chromeMediaSourceId: sourceId,
                                        minWidth: screenSize?.width || 1920,
                                        maxWidth: screenSize?.width || 1920,
                                        minHeight: screenSize?.height || 1080,
                                        maxHeight: screenSize?.height || 1080
                                    }
                                }
                            });
                            
                            videoElement.srcObject = stream;
                            videoElement.style.display = 'block';
                            
                            // Wait for video metadata to load to get actual dimensions
                            videoElement.addEventListener('loadedmetadata', () => {
                                const videoWidth = videoElement.videoWidth;
                                const videoHeight = videoElement.videoHeight;
                                
                                if (videoWidth && videoHeight) {
                                    // Calculate thumbnail size while maintaining aspect ratio
                                    const maxWidth = 400;
                                    const maxHeight = 300;
                                    const aspectRatio = videoWidth / videoHeight;
                                    
                                    let windowWidth, windowHeight;
                                    
                                    // Scale to thumbnail size maintaining aspect ratio
                                    if (aspectRatio > maxWidth / maxHeight) {
                                        // Video is wider - fit to max width
                                        windowWidth = maxWidth;
                                        windowHeight = maxWidth / aspectRatio;
                                    } else {
                                        // Video is taller - fit to max height
                                        windowHeight = maxHeight;
                                        windowWidth = maxHeight * aspectRatio;
                                    }
                                    
                                    // Ensure minimum size
                                    windowWidth = Math.max(windowWidth, 200);
                                    windowHeight = Math.max(windowHeight, 120);
                                    
                                    // Add space for status overlay
                                    windowHeight += 20;
                                    
                                    // Resize window to thumbnail size
                                    if (window.electronAPI.resizeWindow) {
                                        window.electronAPI.resizeWindow({
                                            width: Math.round(windowWidth),
                                            height: Math.round(windowHeight)
                                        });
                                    }
                                    
                                    console.debug('Resizing preview to:', Math.round(windowWidth), 'x', Math.round(windowHeight), 'for video:', videoWidth, 'x', videoHeight);
                                }
                            }, { once: true });
                        } else {
                            videoElement.srcObject = null;
                            videoElement.style.display = 'none';
                            statusOverlay.textContent = 'No Screen Share Source';
                        }
                    } else {
                        statusOverlay.textContent = 'Screen Share Inactive';
                        document.title = 'Teams for Linux - Nothing is being shared';
                        videoElement.srcObject = null;
                        videoElement.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error updating screen share preview:', error);
                    statusOverlay.textContent = 'Error: ' + error.message;
                    videoElement.srcObject = null;
                    videoElement.style.display = 'none';
                }
            };

            // Initial status and stream update
            updateStatusAndStream();
            
            // Listen for screen sharing status changes
            if (window?.electronAPI?.onScreenSharingStatusChanged) {
                window.electronAPI.onScreenSharingStatusChanged(() => {
                    updateStatusAndStream();
                });
            }
        });
    </script>
</body>
</html>