name: Generate Changelog Entry

# SECURITY NOTE: Using pull_request_target to enable commenting on external fork PRs.
# This trigger runs in the base repository context with full permissions.
# CRITICAL: We must NEVER checkout and execute code from forks with this trigger.
# The workflow only uses PR metadata (title, body) for Gemini API calls, which is safe.
# Checkout is only performed for internal PRs where head.repo == base.repo.

on:
  pull_request_target:
    types: [opened, synchronize]
    branches: [main]

jobs:
  generate-changelog:
    runs-on: ubuntu-latest
    # Skip changelog generation for release PRs
    if: ${{ !startsWith(github.event.pull_request.head.ref, 'release/') }}
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Detect fork status and check changelog existence
        id: setup
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const headRepo = context.payload.pull_request.head.repo.full_name;
            const baseRepo = context.payload.pull_request.base.repo.full_name;
            const isExternalFork = headRepo !== baseRepo;
            const prNumber = context.payload.pull_request.number;

            core.setOutput('is_external_fork', isExternalFork.toString());
            console.log(`Fork status: ${isExternalFork ? 'external fork' : 'internal'} (${headRepo} vs ${baseRepo})`);

            // Check if changelog already exists using GitHub API (safe - no code execution)
            // For external forks, we check their repo; for internal PRs, we check the base repo
            const repoOwner = context.payload.pull_request.head.repo.owner.login;
            const repoName = context.payload.pull_request.head.repo.name;

            try {
              await github.rest.repos.getContent({
                owner: repoOwner,
                repo: repoName,
                path: `.changelog/pr-${prNumber}.txt`,
                ref: context.payload.pull_request.head.sha
              });
              core.setOutput('changelog_exists', 'true');
              console.log('‚úÖ Changelog file already exists, skipping generation');
            } catch (e) {
              if (e.status === 404) {
                core.setOutput('changelog_exists', 'false');
                console.log('üìù Changelog file not found, will generate');
              } else {
                // For other errors (e.g., rate limiting), log and continue
                console.log(`‚ö†Ô∏è Could not check changelog existence: ${e.message}`);
                core.setOutput('changelog_exists', 'false');
              }
            }

      # Only checkout for internal PRs where we need to commit the changelog
      # SECURITY: Never checkout external fork code with pull_request_target
      - name: Checkout PR branch (internal PRs only)
        if: steps.setup.outputs.is_external_fork == 'false' && steps.setup.outputs.changelog_exists == 'false'
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate summary with Gemini
        if: steps.setup.outputs.changelog_exists == 'false'
        id: gemini
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const prTitle = context.payload.pull_request.title;
            const prBody = context.payload.pull_request.body || '';

            // Truncate body safely (first 1000 chars)
            const cleanBody = prBody.substring(0, 1000).replace(/"/g, "'");

            const prompt = `Summarize this PR in ONE concise line suitable for a changelog (max 80 chars):

            Title: ${prTitle}

            Description: ${cleanBody}

            Guidelines:
            - Start with action verb (Add/Fix/Update/Remove)
            - Focus on user-facing impact
            - Max 80 characters
            - Professional tone

            Example: "Add MQTT integration for Teams status publishing"`;

            try {
              const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${process.env.GEMINI_API_KEY}`,
                {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                      temperature: 0.3,
                      maxOutputTokens: 50
                    }
                  })
                }
              );

              const data = await response.json();
              const summary = data.candidates[0].content.parts[0].text.trim();

              core.setOutput('summary', summary);
              console.log(`Generated: ${summary}`);
            } catch (error) {
              console.log(`Gemini API failed, using PR title as fallback`);
              core.setOutput('summary', prTitle);
            }

      - name: Post-process summary
        if: steps.setup.outputs.changelog_exists == 'false'
        id: final
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            let summary = `${{ steps.gemini.outputs.summary }}`;
            const author = context.payload.pull_request.user.login;
            const prNum = context.payload.pull_request.number;

            // Add author if not a bot
            if (!author.includes('bot')) {
              summary = `${summary} - by @${author}`;
            }

            // Add PR number
            summary = `${summary} (#${prNum})`;

            core.setOutput('final_summary', summary);
            console.log(`Final: ${summary}`);

      - name: Save changelog entry (internal PRs only)
        if: steps.setup.outputs.is_external_fork == 'false' && steps.setup.outputs.changelog_exists == 'false'
        run: |
          mkdir -p .changelog
          echo "${{ steps.final.outputs.final_summary }}" > .changelog/pr-${{ github.event.pull_request.number }}.txt

          echo "‚úÖ Created: .changelog/pr-${{ github.event.pull_request.number }}.txt"
          cat .changelog/pr-${{ github.event.pull_request.number }}.txt

      - name: Commit changelog file to PR branch (internal PRs only)
        if: steps.setup.outputs.is_external_fork == 'false' && steps.setup.outputs.changelog_exists == 'false'
        env:
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b temp-changelog-branch
          git add .changelog/
          git commit -m "chore: add changelog entry for PR #${{ github.event.pull_request.number }}"
          git push origin "HEAD:${PR_BRANCH}"
          echo "‚úÖ Changelog entry committed to PR branch"

      - name: Comment on PR (internal)
        if: steps.setup.outputs.is_external_fork == 'false' && steps.setup.outputs.changelog_exists == 'false'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚úÖ Changelog entry generated and committed to this PR:\n\n\`\`\`\n${{ steps.final.outputs.final_summary }}\n\`\`\`\n\nThe file \`.changelog/pr-${{ github.event.pull_request.number }}.txt\` will be included when you merge this PR.\n\nYou can edit it directly in this PR if needed.`
            })

      - name: Comment on PR (external fork)
        if: steps.setup.outputs.is_external_fork == 'true' && steps.setup.outputs.changelog_exists == 'false'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const summary = `${{ steps.final.outputs.final_summary }}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üìù **Changelog entry generated:**\n\n\`\`\`\n${summary}\n\`\`\`\n\n---\n\n**To add this to your PR**, create \`.changelog/pr-${prNumber}.txt\`:\n\n\`\`\`bash\ncat <<'EOF' > .changelog/pr-${prNumber}.txt\n${summary}\nEOF\ngit add .changelog/ && git commit -m "chore: add changelog entry" && git push\n\`\`\`\n\nOr create the file manually with the content above.\n\n> **Note:** This step is required for external contributions. If not added, a maintainer will add it during the release process.`
            })
