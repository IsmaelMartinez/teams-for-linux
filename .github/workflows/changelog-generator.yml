name: Generate Changelog Entry

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

jobs:
  check-changelog:
    runs-on: ubuntu-latest
    # Skip changelog generation for release PRs
    if: ${{ !startsWith(github.event.pull_request.head.ref, 'release/') }}
    outputs:
      exists: ${{ steps.check.outputs.exists }}

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if changelog already exists
        id: check
        run: |
          if [ -f ".changelog/pr-${{ github.event.pull_request.number }}.txt" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Changelog file already exists, skipping generation"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "ðŸ“ Changelog file not found, will generate"
          fi

  generate-changelog:
    runs-on: ubuntu-latest
    needs: check-changelog
    # Only run if changelog doesn't exist
    if: needs.check-changelog.outputs.exists == 'false'
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate summary with Gemini
        id: gemini
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const prTitle = context.payload.pull_request.title;
            const prBody = context.payload.pull_request.body || '';

            // Truncate body safely (first 1000 chars)
            const cleanBody = prBody.substring(0, 1000).replace(/"/g, "'");

            const prompt = `Summarize this PR in ONE concise line suitable for a changelog (max 80 chars):

            Title: ${prTitle}

            Description: ${cleanBody}

            Guidelines:
            - Start with action verb (Add/Fix/Update/Remove)
            - Focus on user-facing impact
            - Max 80 characters
            - Professional tone

            Example: "Add MQTT integration for Teams status publishing"`;

            try {
              const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${process.env.GEMINI_API_KEY}`,
                {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                      temperature: 0.3,
                      maxOutputTokens: 50
                    }
                  })
                }
              );

              const data = await response.json();
              const summary = data.candidates[0].content.parts[0].text.trim();

              core.setOutput('summary', summary);
              console.log(`Generated: ${summary}`);
            } catch (error) {
              console.log(`Gemini API failed, using PR title as fallback`);
              core.setOutput('summary', prTitle);
            }

      - name: Post-process summary
        id: final
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            let summary = `${{ steps.gemini.outputs.summary }}`;
            const author = context.payload.pull_request.user.login;
            const prNum = context.payload.pull_request.number;

            // Add author if not a bot
            if (!author.includes('bot')) {
              summary = `${summary} - by @${author}`;
            }

            // Add PR number
            summary = `${summary} (#${prNum})`;

            // Detect if PR is from external fork
            const headRepo = context.payload.pull_request.head.repo.full_name;
            const baseRepo = context.payload.pull_request.base.repo.full_name;
            const isExternalFork = headRepo !== baseRepo;

            core.setOutput('final_summary', summary);
            core.setOutput('is_external_fork', isExternalFork.toString());
            console.log(`Final: ${summary}`);
            console.log(`External fork: ${isExternalFork} (${headRepo} vs ${baseRepo})`);

      - name: Save changelog entry
        if: steps.final.outputs.is_external_fork == 'false'
        run: |
          mkdir -p .changelog
          echo "${{ steps.final.outputs.final_summary }}" > .changelog/pr-${{ github.event.pull_request.number }}.txt

          echo "âœ… Created: .changelog/pr-${{ github.event.pull_request.number }}.txt"
          cat .changelog/pr-${{ github.event.pull_request.number }}.txt

      - name: Commit changelog file to PR branch
        if: steps.final.outputs.is_external_fork == 'false'
        env:
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b temp-changelog-branch
          git add .changelog/
          git commit -m "chore: add changelog entry for PR #${{ github.event.pull_request.number }}"
          git push origin "HEAD:${PR_BRANCH}"
          echo "âœ… Changelog entry committed to PR branch"

      - name: Comment on PR (internal)
        if: steps.final.outputs.is_external_fork == 'false'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… Changelog entry generated and committed to this PR:\n\n\`\`\`\n${{ steps.final.outputs.final_summary }}\n\`\`\`\n\nThe file \`.changelog/pr-${{ github.event.pull_request.number }}.txt\` will be included when you merge this PR.\n\nYou can edit it directly in this PR if needed.`
            })

      - name: Comment on PR (external fork)
        if: steps.final.outputs.is_external_fork == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const summary = `${{ steps.final.outputs.final_summary }}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸ“ **Changelog entry generated:**\n\n\`\`\`\n${summary}\n\`\`\`\n\n---\n\n**To add this to your PR**, create \`.changelog/pr-${prNumber}.txt\`:\n\n\`\`\`bash\necho '${summary}' > .changelog/pr-${prNumber}.txt\ngit add .changelog/ && git commit -m "chore: add changelog entry" && git push\n\`\`\`\n\nOr create the file manually with the content above.\n\n> **Note:** This step is required for external contributions. If not added, a maintainer will add it during the release process.`
            })
