name: Snap Build

on: push

defaults:
  run:
    shell: bash

jobs:
  snap:
    runs-on: ubuntu-latest

    env:
      SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_TOKEN }}
      SNAPCRAFT_BUILD_ENVIRONMENT: lxd

    steps:
      - name: Install Snapcraft
        uses: samuelmeuli/action-snapcraft@d33c176a9b784876d966f80fb1b461808edc0641 # v2.1.1

      - name: Install and initialize LXD
        uses: canonical/setup-lxd@62cd335190e2b612b427db9319ea6b59ab1691f8 # main

      - name: Check out Git repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Install Node.js and NPM
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22

      - name: Build
        run: npm ci

      - name: Build for Release
        if: contains(github.ref, 'main')
        run: npm run dist:linux:snap -- --publish always

      - name: Build for PR
        if: "!contains(github.ref, 'main')"
        run: npm run dist:linux:snap -- --publish never

      - name: Upload PR artifacts
        if: "!contains(github.ref, 'main')"
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: teams-for-linux-snap-x64
          path: dist/*.snap
          retention-days: 30
          compression-level: 0

  snap-armv7l:
    runs-on: ubuntu-latest

    env:
      SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_TOKEN }}
      # Note: No LXD - electron-builder handles armv7l cross-compilation directly

    steps:
      - name: Install Snapcraft
        uses: samuelmeuli/action-snapcraft@d33c176a9b784876d966f80fb1b461808edc0641 # v2.1.1

      - name: Check out Git repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Install Node.js and NPM
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22

      - name: Build
        run: npm ci

      - name: Build for Release
        if: contains(github.ref, 'main')
        run: npm run dist:linux:snap:armv7l -- --publish always

      - name: Build for PR
        if: "!contains(github.ref, 'main')"
        run: npm run dist:linux:snap:armv7l -- --publish never

      - name: Upload PR artifacts
        if: "!contains(github.ref, 'main')"
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: teams-for-linux-snap-armv7l
          path: dist/*.snap
          retention-days: 30
          compression-level: 0

  snap-arm64:
    runs-on: ubuntu-24.04-arm

    env:
      SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_TOKEN }}
      SNAPCRAFT_BUILD_ENVIRONMENT: lxd

    steps:
      - name: Install Snapcraft
        uses: samuelmeuli/action-snapcraft@d33c176a9b784876d966f80fb1b461808edc0641 # v2.1.1

      - name: Install and initialize LXD
        uses: canonical/setup-lxd@62cd335190e2b612b427db9319ea6b59ab1691f8 # main

      - name: Check out Git repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Install Node.js and NPM
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22

      - name: Build
        run: npm ci

      - name: Build for Release
        if: contains(github.ref, 'main')
        run: npm run dist:linux:snap:arm64 -- --publish always

      - name: Build for PR
        if: "!contains(github.ref, 'main')"
        run: npm run dist:linux:snap:arm64 -- --publish never

      - name: Upload PR artifacts
        if: "!contains(github.ref, 'main')"
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: teams-for-linux-snap-arm64
          path: dist/*.snap
          retention-days: 30
          compression-level: 0

  comment-artifacts:
    runs-on: ubuntu-latest
    if: "!contains(github.ref, 'main')"
    needs: [snap, snap-armv7l, snap-arm64]
    permissions:
      pull-requests: write
      actions: read

    steps:
      - name: Comment on PR with snap artifacts
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            // Find PR for this branch
            const branchName = context.ref.replace('refs/heads/', '');
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            const pr = prs.find(p => p.head.ref === branchName);

            if (!pr) {
              console.log(`No PR found for branch ${branchName}`);
              return;
            }

            const { data: artifacts } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });

            const snapArtifacts = artifacts.artifacts.filter(a => a.name.includes('snap'));

            if (snapArtifacts.length === 0) {
              console.log('No snap artifacts found');
              return;
            }

            // Group artifacts by architecture
            const snapX64 = snapArtifacts.find(a => a.name.includes('snap-x64'));
            const snapArm64 = snapArtifacts.find(a => a.name.includes('snap-arm64'));
            const snapArmv7l = snapArtifacts.find(a => a.name.includes('snap-armv7l'));

            let body = '## ðŸ“¦ PR Snap Build Artifacts\n\n';
            body += 'âœ… **Snap builds successful!** Download artifacts:\n\n';
            body += '### ðŸ§ Linux Snap Packages\n\n';

            if (snapX64) {
              const sizeMB = (snapX64.size_in_bytes / 1024 / 1024).toFixed(2);
              body += `**x86_64** (${sizeMB} MB)\n`;
              body += `- [${snapX64.name}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}/artifacts/${snapX64.id})\n\n`;
            }
            if (snapArm64) {
              const sizeMB = (snapArm64.size_in_bytes / 1024 / 1024).toFixed(2);
              body += `**arm64** (${sizeMB} MB)\n`;
              body += `- [${snapArm64.name}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}/artifacts/${snapArm64.id})\n\n`;
            }
            if (snapArmv7l) {
              const sizeMB = (snapArmv7l.size_in_bytes / 1024 / 1024).toFixed(2);
              body += `**armv7l** (${sizeMB} MB)\n`;
              body += `- [${snapArmv7l.name}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}/artifacts/${snapArmv7l.id})\n\n`;
            }

            body += '---\n\n';
            body += `ðŸ“ **Note:** Other package formats (.deb, .rpm, .AppImage, .dmg, .exe) are built in the [main workflow](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/workflows/build.yml)\n\n`;
            body += `[View workflow run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('## ðŸ“¦ PR Snap Build Artifacts')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body
              });
            }
