name: Build & Release

env:
  GH_TOKEN: ${{ SECRETS.GITHUB_TOKEN }}

on: push

defaults:
  run:
    shell: bash

jobs:
  e2e_tests:
    runs-on: ubuntu-latest

    steps:
      - name: Check out Git repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Install Node.js and NPM
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:unit

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests
        run: xvfb-run --auto-servernum --server-args="-screen 0 1280x960x24" npm run test:e2e

      - name: Upload Playwright test results
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: playwright-test-results
          path: test-results/
          retention-days: 7

  linux_x64:
    runs-on: ubuntu-latest

    steps:
      - name: Check out Git repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Install Node.js and NPM
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22

      - name: Build
        run: npm ci

      - name: Validate Release Notes
        run: npm run generate-release-info

      - name: Build for Release
        if: contains(github.ref, 'main')
        run: npm run dist:linux:x64 -- --publish always

      - name: Add AppImage update info
        if: contains(github.ref, 'main')
        run: |
          # Install squashfs-tools for extraction without execute permissions
          sudo apt-get update && sudo apt-get install -y squashfs-tools

          # Download appimagetool
          wget -q https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

          # Process each x86_64 AppImage
          for appimage in dist/*x86_64*.AppImage; do
            if [ -f "$appimage" ]; then
              echo "Processing $appimage"

              # Extract the AppImage using unsquashfs (doesn't require execute permissions)
              offset=$(grep -abom 1 'hsqs' "$appimage" | head -1 | cut -d: -f1)
              unsquashfs -d squashfs-root -offset "$offset" "$appimage"

              # Repack with update info (use --appimage-extract-and-run to avoid FUSE requirement)
              ARCH=x86_64 ./appimagetool-x86_64.AppImage --appimage-extract-and-run \
                -u "gh-releases-zsync|IsmaelMartinez|teams-for-linux|latest|teams-for-linux-*x86_64*.AppImage.zsync" \
                squashfs-root \
                "$appimage"

              # Cleanup
              rm -rf squashfs-root

              echo "Successfully added update info to $appimage"
            fi
          done

      - name: Upload AppImage with update info to release
        if: contains(github.ref, 'main')
        run: |
          # Get version from package.json
          VERSION=$(node -p "require('./package.json').version")
          TAG="v$VERSION"

          # Upload the repackaged AppImage and zsync file to the release
          for file in dist/*x86_64*.AppImage dist/*x86_64*.AppImage.zsync; do
            if [ -f "$file" ]; then
              echo "Uploading $file to release $TAG"
              gh release upload "$TAG" "$file" --clobber || echo "Warning: Could not upload $file"
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build for PR
        if: "!contains(github.ref, 'main')"
        run: npm run dist:linux:x64 -- --publish never

      - name: Upload PR artifacts
        if: "!contains(github.ref, 'main')"
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: teams-for-linux-linux-x64
          path: |
            dist/*.deb
            dist/*.rpm
            dist/*.tar.gz
            dist/*.AppImage
          retention-days: 30
          compression-level: 6

  linux_arm64:
    runs-on: ubuntu-latest

    steps:
      - name: Check out Git repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Install Node.js and NPM
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22

      - name: Build
        run: npm ci

      - name: Validate Release Notes
        run: npm run generate-release-info

      - name: Build for Release
        if: contains(github.ref, 'main')
        run: npm run dist:linux:arm64 -- --publish always

      - name: Build for PR
        if: "!contains(github.ref, 'main')"
        run: npm run dist:linux:arm64 -- --publish never

      - name: Add AppImage update info
        if: contains(github.ref, 'main')
        run: |
          # Install squashfs-tools for cross-architecture extraction
          sudo apt-get update && sudo apt-get install -y squashfs-tools

          # Download appimagetool
          wget -q https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

          # Process each arm64 AppImage
          for appimage in dist/*arm64*.AppImage; do
            if [ -f "$appimage" ]; then
              echo "Processing $appimage"

              # Extract the AppImage using unsquashfs (works cross-architecture)
              offset=$(grep -abom 1 'hsqs' "$appimage" | head -1 | cut -d: -f1)
              unsquashfs -d squashfs-root -offset "$offset" "$appimage"

              # Repack with update info
              ARCH=aarch64 ./appimagetool-x86_64.AppImage --appimage-extract-and-run \
                -u "gh-releases-zsync|IsmaelMartinez|teams-for-linux|latest|teams-for-linux-*arm64*.AppImage.zsync" \
                squashfs-root \
                "$appimage"

              rm -rf squashfs-root
              echo "Successfully added update info to $appimage"
            fi
          done

      - name: Upload AppImage with update info to release
        if: contains(github.ref, 'main')
        run: |
          VERSION=$(node -p "require('./package.json').version")
          TAG="v$VERSION"

          for file in dist/*arm64*.AppImage dist/*arm64*.AppImage.zsync; do
            if [ -f "$file" ]; then
              echo "Uploading $file to release $TAG"
              gh release upload "$TAG" "$file" --clobber || echo "Warning: Could not upload $file"
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload PR artifacts
        if: "!contains(github.ref, 'main')"
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: teams-for-linux-linux-arm64
          path: |
            dist/*.deb
            dist/*.rpm
            dist/*.tar.gz
            dist/*.AppImage
          retention-days: 30
          compression-level: 6

  linux_arm:
    runs-on: ubuntu-latest

    steps:
      - name: Check out Git repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Install Node.js and NPM
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22

      - name: Build
        run: npm ci

      - name: Validate Release Notes
        run: npm run generate-release-info

      - name: Build for Release
        if: contains(github.ref, 'main')
        run: npm run dist:linux:arm -- --publish always

      - name: Build for PR
        if: "!contains(github.ref, 'main')"
        run: npm run dist:linux:arm -- --publish never

      - name: Add AppImage update info
        if: contains(github.ref, 'main')
        run: |
          # Install squashfs-tools for cross-architecture extraction
          sudo apt-get update && sudo apt-get install -y squashfs-tools

          # Download appimagetool
          wget -q https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

          # Process each armv7l AppImage
          for appimage in dist/*armv7l*.AppImage; do
            if [ -f "$appimage" ]; then
              echo "Processing $appimage"

              # Extract the AppImage using unsquashfs (works cross-architecture)
              offset=$(grep -abom 1 'hsqs' "$appimage" | head -1 | cut -d: -f1)
              unsquashfs -d squashfs-root -offset "$offset" "$appimage"

              # Repack with update info
              ARCH=armhf ./appimagetool-x86_64.AppImage --appimage-extract-and-run \
                -u "gh-releases-zsync|IsmaelMartinez|teams-for-linux|latest|teams-for-linux-*armv7l*.AppImage.zsync" \
                squashfs-root \
                "$appimage"

              rm -rf squashfs-root
              echo "Successfully added update info to $appimage"
            fi
          done

      - name: Upload AppImage with update info to release
        if: contains(github.ref, 'main')
        run: |
          VERSION=$(node -p "require('./package.json').version")
          TAG="v$VERSION"

          for file in dist/*armv7l*.AppImage dist/*armv7l*.AppImage.zsync; do
            if [ -f "$file" ]; then
              echo "Uploading $file to release $TAG"
              gh release upload "$TAG" "$file" --clobber || echo "Warning: Could not upload $file"
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload PR artifacts
        if: "!contains(github.ref, 'main')"
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: teams-for-linux-linux-armv7l
          path: |
            dist/*.deb
            dist/*.rpm
            dist/*.tar.gz
            dist/*.AppImage
          retention-days: 30
          compression-level: 6

  dmg:
    runs-on: macos-latest

    steps:
      - name: Check out Git repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Install Node.js and NPM
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22

      - name: Build
        run: npm ci

      - name: Validate Release Notes
        run: npm run generate-release-info

      - name: Build for Release
        if: contains(github.ref, 'main')
        run: npm run dist:mac:x64 -- --publish always

      - name: Build for PR
        if: "!contains(github.ref, 'main')"
        run: npm run dist:mac:x64 -- --publish never

      - name: Upload PR artifacts
        if: "!contains(github.ref, 'main')"
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: teams-for-linux-macos-x64
          path: dist/*.dmg
          retention-days: 30
          compression-level: 6

  exe:
    runs-on: windows-latest

    steps:
      - name: Check out Git repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Install Node.js and NPM
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22

      - name: Build
        run: npm ci

      - name: Validate Release Notes
        run: npm run generate-release-info

      - name: Build for Release
        if: contains(github.ref, 'main')
        run: npm run dist:windows -- --publish always

      - name: Build for PR
        if: "!contains(github.ref, 'main')"
        run: npm run dist:windows -- --publish never

      - name: Upload PR artifacts
        if: "!contains(github.ref, 'main')"
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: teams-for-linux-windows-x64
          path: dist/*.exe
          retention-days: 30
          compression-level: 6

  comment-artifacts:
    runs-on: ubuntu-latest
    if: "!contains(github.ref, 'main')"
    needs: [linux_x64, linux_arm64, linux_arm, dmg, exe]
    permissions:
      pull-requests: write
      actions: read

    steps:
      - name: Comment on PR with artifact links
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            // Find PR for this branch
            const branchName = context.ref.replace('refs/heads/', '');
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            const pr = prs.find(p => p.head.ref === branchName);

            if (!pr) {
              console.log(`No PR found for branch ${branchName}`);
              return;
            }

            const { data: artifacts } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });

            const buildArtifacts = artifacts.artifacts.filter(a =>
              !a.name.includes('test-results') && !a.name.includes('playwright')
            );

            if (buildArtifacts.length === 0) {
              console.log('No build artifacts found');
              return;
            }

            // Group artifacts by platform
            const linuxX64 = buildArtifacts.find(a => a.name.includes('linux-x64'));
            const linuxArm64 = buildArtifacts.find(a => a.name.includes('linux-arm64'));
            const linuxArmv7l = buildArtifacts.find(a => a.name.includes('linux-armv7l'));
            const macos = buildArtifacts.find(a => a.name.includes('macos'));
            const windows = buildArtifacts.find(a => a.name.includes('windows'));

            let body = '## ðŸ“¦ PR Build Artifacts\n\nâœ… **Build successful!** Download artifacts:\n\n';

            // Linux section
            body += '### ðŸ§ Linux\n\n';
            if (linuxX64) {
              const sizeMB = (linuxX64.size_in_bytes / 1024 / 1024).toFixed(2);
              body += `**x86_64** (${sizeMB} MB) - Contains: .deb, .rpm, .tar.gz, .AppImage\n`;
              body += `- [${linuxX64.name}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}/artifacts/${linuxX64.id})\n\n`;
            }
            if (linuxArm64) {
              const sizeMB = (linuxArm64.size_in_bytes / 1024 / 1024).toFixed(2);
              body += `**arm64** (${sizeMB} MB) - Contains: .deb, .rpm, .tar.gz, .AppImage\n`;
              body += `- [${linuxArm64.name}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}/artifacts/${linuxArm64.id})\n\n`;
            }
            if (linuxArmv7l) {
              const sizeMB = (linuxArmv7l.size_in_bytes / 1024 / 1024).toFixed(2);
              body += `**armv7l** (${sizeMB} MB) - Contains: .deb, .rpm, .tar.gz, .AppImage\n`;
              body += `- [${linuxArmv7l.name}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}/artifacts/${linuxArmv7l.id})\n\n`;
            }

            // macOS section
            if (macos) {
              const sizeMB = (macos.size_in_bytes / 1024 / 1024).toFixed(2);
              body += '### ðŸŽ macOS\n\n';
              body += `**x86_64** (${sizeMB} MB) - Contains: .dmg\n`;
              body += `- [${macos.name}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}/artifacts/${macos.id})\n\n`;
            }

            // Windows section
            if (windows) {
              const sizeMB = (windows.size_in_bytes / 1024 / 1024).toFixed(2);
              body += '### ðŸªŸ Windows\n\n';
              body += `**x86_64** (${sizeMB} MB) - Contains: .exe installer\n`;
              body += `- [${windows.name}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}/artifacts/${windows.id})\n\n`;
            }

            body += '---\n\n';
            body += `ðŸ“ **Note:** Snap packages (.snap) are built in a [separate workflow](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/workflows/snap.yml)\n\n`;
            body += `[View workflow run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n`;

            // Add last updated timestamp
            const now = new Date();
            const updateTime = now.toISOString().slice(0, 16).replace('T', ' ') + ' UTC';
            body += `ðŸ• **Last updated:** ${updateTime}`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('## ðŸ“¦ PR Build Artifacts')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body
              });
            }
